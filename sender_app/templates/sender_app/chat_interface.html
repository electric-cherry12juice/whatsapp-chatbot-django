{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat</title>
    <link rel="stylesheet" href="{% static 'sender_app/css/styles.css' %}">
</head>
<body>
    <!-- "Add New Chat" Modal (hidden by default) -->
    <div id="add-chat-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Start a New Chat</h3>
            <form id="add-chat-form" class="modal-form">
                <input type="text" id="new-chat-number" name="phone_number" placeholder="Enter phone number (e.g., 15551234567)" required>
                <input type="text" id="new-chat-template" name="template_name" placeholder="Enter template name (e.g., hello_world)" required>
                <button type="submit">Send Template & Start Chat</button>
                <div id="modal-error" class="hidden"></div>
            </form>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar with Contact List -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="header-top-row">
                    <h2>Chats</h2>
                    <div class="header-actions">
                        <button class="action-btn" title="New Chat" onclick="openModal()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M19.005 3.175H4.674C3.642 3.175 3 3.784 3 4.792v10.327c0 .525.22 1.023.6 1.394l2.85 2.851c.371.371.87.592 1.394.592h11.161c1.032 0 1.64-1.284 1.64-2.292V4.792c0-1.008-.608-1.617-1.64-1.617zM4.674 4.425h14.331c.448 0 .448.425.448.867v10.327c0 .442 0 .867-.448.867H8.918a.563.563 0 0 1-.398-.166L5.67 13.52a.563.563 0 0 1-.166-.398V4.792c0-.442.02-.367.448-.367zM11 11.25H8v1.5h3v3h1.5v-3h3v-1.5h-3v-3H11v3z"></path></svg>
                        </button>
                        <form action="{% url 'logout_view' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="action-btn" title="Logout">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 4l1.4 1.4L7.8 11H20v2H7.8l5.6 5.6L12 20l-8-8 8-8z"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="search-bar">
                    <input type="text" id="search-contacts" placeholder="Search chats..." onkeyup="filterContacts()">
                </div>
            </header>
            <div class="contact-list" id="contact-list-panel">
                {% for contact in contacts %}
                    <div class="contact-item" data-phone="{{ contact }}" onclick="loadChat('{{ contact }}')">
                        {{ contact }}
                    </div>
                {% endfor %}
            </div>
        </aside>

        <!-- Main Chat Panel -->
        <main class="chat-panel" id="chat-panel">
            <!-- This part remains the same as the previous version -->
            <!-- ... chat-placeholder and active-chat-area ... -->
        </main>
    </div>

    <script>
        // ... All existing JS functions remain the same (loadChat, appendMessage, sendMessage) ...
        
        // --- NEW JAVASCRIPT FOR NEW FEATURES ---

        const modal = document.getElementById('add-chat-modal');
        const modalError = document.getElementById('modal-error');

        function openModal() {
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modalError.classList.add('hidden');
            document.getElementById('add-chat-form').reset();
        }

        document.getElementById('add-chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const phoneNumber = document.getElementById('new-chat-number').value;
            const templateName = document.getElementById('new-chat-template').value;
            const submitButton = this.querySelector('button');
            submitButton.textContent = 'Sending...';
            submitButton.disabled = true;
            modalError.classList.add('hidden');

            fetch("{% url 'start_new_chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ phone_number: phoneNumber, template_name: templateName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    // Add new contact to list if it doesn't exist, then load the chat
                    if (!document.querySelector(`.contact-item[data-phone="${data.phone_number}"]`)) {
                        const contactList = document.getElementById('contact-list-panel');
                        const newContactEl = document.createElement('div');
                        newContactEl.className = 'contact-item';
                        newContactEl.dataset.phone = data.phone_number;
                        newContactEl.textContent = data.phone_number;
                        newContactEl.onclick = () => loadChat(data.phone_number);
                        contactList.prepend(newContactEl);
                    }
                    loadChat(data.phone_number);
                } else {
                    modalError.textContent = data.error || 'An unknown error occurred.';
                    modalError.classList.remove('hidden');
                }
            })
            .catch(err => {
                modalError.textContent = 'A network error occurred. Please try again.';
                modalError.classList.remove('hidden');
            })
            .finally(() => {
                submitButton.textContent = 'Send Template & Start Chat';
                submitButton.disabled = false;
            });
        });

        function filterContacts() {
            const searchTerm = document.getElementById('search-contacts').value.toLowerCase();
            const contacts = document.querySelectorAll('.contact-item');
            contacts.forEach(contact => {
                const phoneNumber = contact.dataset.phone.toLowerCase();
                if (phoneNumber.includes(searchTerm)) {
                    contact.style.display = '';
                } else {
                    contact.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>

