{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat</title>
    <link rel="stylesheet" href="{% static 'sender_app/css/styles.css' %}">
</head>
<body>
    <div id="add-chat-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Start a New Chat</h3>
            <form id="add-chat-form" class="modal-form">
                <input type="tel" id="new-chat-number" placeholder="Enter phone number (e.g., 15551234567)" required>
                <input type="text" id="new-chat-template" placeholder="Enter template name (e.g., hello_world)" required>
                <button type="submit">Send Template & Start Chat</button>
                <div id="modal-error" class="hidden"></div>
            </form>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="header-top-row">
                    <h2 id="sidebar-title">Chats</h2>
                    <button id="back-btn" class="back-btn hidden" onclick="backToAllChats()">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                        <span>Search Results</span>
                    </button>
                    <div class="header-actions">
                        <button class="action-btn" title="New Chat" onclick="openModal()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M22 4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14l4 4V4z M11 11H8v2h3v3h2v-3h3v-2h-3V8h-2v3z"></path></svg>
                        </button>
                        <form action="{% url 'logout_view' %}" method="post" style="display: flex;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn" title="Logout">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5a2 2 0 0 0-2 2v4h2V5h14v14H5v-4H3v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="Search or start new chat">
                    </div>
                    <button id="clear-search-btn" class="clear-search-btn hidden">&times;</button>
                </div>
            </header>
            <div class="contact-list" id="contact-list">
                {% for contact in contacts %}
                    <div class="contact-item" data-phone="{{ contact }}">
                        <span class="contact-name">{{ contact }}</span>
                        <button class="delete-chat-btn">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                        </button>
                    </div>
                {% endfor %}
            </div>
        </aside>

        <main class="chat-panel" id="chat-panel">
            <div id="chat-placeholder" class="">
                <h2>Select a chat to start messaging</h2>
            </div>
            <div id="active-chat-area" class="hidden">
                <header class="chat-header" id="chat-header"></header>
                <div class="chat-log" id="chat-log">
                    <div class="chat-log-container" id="chat-log-container"></div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-message-input" placeholder="Type a message...">
                    <button id="chat-message-submit">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const DOM = {
            contactList: document.getElementById('contact-list'),
            chatPanel: document.getElementById('chat-panel'),
            chatPlaceholder: document.getElementById('chat-placeholder'),
            activeChatArea: document.getElementById('active-chat-area'),
            chatHeader: document.getElementById('chat-header'),
            chatLog: document.getElementById('chat-log'),
            chatLogContainer: document.getElementById('chat-log-container'),
            messageInput: document.getElementById('chat-message-input'),
            messageSubmit: document.getElementById('chat-message-submit'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.getElementById('clear-search-btn'),
            sidebarTitle: document.getElementById('sidebar-title'),
            backBtn: document.getElementById('back-btn'),
            modal: document.getElementById('add-chat-modal'),
            modalError: document.getElementById('modal-error'),
            addChatForm: document.getElementById('add-chat-form'),
        };

        let state = {
            activePhoneNumber: null,
            chatSocket: null,
            searchTimeout: null,
        };

        function scrollToBottom() {
            DOM.chatLog.scrollTop = DOM.chatLog.scrollHeight;
        }

        function setupWebSocket(phoneNumber) {
            if (state.chatSocket) state.chatSocket.close();
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            state.chatSocket = new WebSocket(`${protocol}${window.location.host}/ws/chat/${phoneNumber}/`);
            state.chatSocket.onmessage = handleWebSocketMessage;
            state.chatSocket.onerror = (e) => console.error('WebSocket Error:', e);
        }

        function handleWebSocketMessage(e) {
            const data = JSON.parse(e.data);
            moveContactToTop(data.sender_id);
            if (state.activePhoneNumber === data.sender_id) {
                appendMessage(data.message, data.is_from_user);
            }
        }

        function loadChat(phoneNumber) {
            state.activePhoneNumber = phoneNumber;
            DOM.chatPlaceholder.classList.add('hidden');
            DOM.activeChatArea.classList.remove('hidden');

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`);
            if (activeEl) activeEl.classList.add('active');

            DOM.chatHeader.textContent = phoneNumber;
            DOM.chatLogContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Loading...</div>';

            if (DOM.searchInput.value.trim() !== '') {
                DOM.sidebarTitle.classList.add('hidden');
                DOM.backBtn.classList.remove('hidden');
            }

            fetch(`/api/chat/${phoneNumber}/`)
                .then(response => response.json())
                .then(data => {
                    DOM.chatLogContainer.innerHTML = '';
                    data.messages.forEach(msg => appendMessage(msg.message_text, msg.is_from_user));
                });
            
            setupWebSocket(phoneNumber);
        }

        function appendMessage(message, isFromUser) {
            const chatLogContainer = document.getElementById('chat-log-container');
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${isFromUser ? 'message-in' : 'message-out'}`;

    // THE FIX: Check for the correct media path
            if (message && (message.startsWith('/media/') || message.startsWith('http'))) {
                if (/\.(jpg|jpeg|png|gif|webp)$/i.test(message)) {
            // Prepend /static for WhiteNoise if it's a local media file
                    const src = message;
                    messageEl.innerHTML = `<img src="${src}" style="max-width: 100%; border-radius: 5px; display: block;" alt="Image">`;
                } else if (/\.(mp3|ogg|amr|wav)$/i.test(message)) {
                    const src = message.startsWith('/media/') ? `/static${message}` : message;
                    messageEl.innerHTML = `<audio controls src="${src}" style="width: 100%; min-width: 250px;">Your browser does not support the audio element.</audio>`;
                } else {
                    messageEl.textContent = message;
                    }
            } else {
                messageEl.textContent = message;
                }
    
    chatLogContainer.appendChild(messageEl);
    scrollToBottom();
}
    

        function sendMessage() {
            const message = DOM.messageInput.value.trim();
            if (!message || !state.chatSocket || state.chatSocket.readyState !== WebSocket.OPEN) return;
            state.chatSocket.send(JSON.stringify({ 'message': message, 'type': 'text' }));
            DOM.messageInput.value = '';
            moveContactToTop(state.activePhoneNumber);
        }

        function openModal() { DOM.modal.classList.remove('hidden'); }
        function closeModal() {
            DOM.modal.classList.add('hidden');
            DOM.modalError.classList.add('hidden');
            DOM.addChatForm.reset();
        }

        function moveContactToTop(phoneNumber) {
            let contactEl = document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`);
            if (contactEl) {
                DOM.contactList.prepend(contactEl);
            } else {
                addContactToList(phoneNumber, true);
            }
        }
        
        function deleteChat(event, phoneNumber) {
            event.stopPropagation();
            if (!confirm(`Delete chat with ${phoneNumber}?`)) return;
            fetch(`/api/delete_chat/${phoneNumber}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`)?.remove();
                    if (state.activePhoneNumber === phoneNumber) {
                        DOM.activeChatArea.classList.add('hidden');
                        DOM.chatPlaceholder.classList.remove('hidden');
                        state.activePhoneNumber = null;
                        if (state.chatSocket) state.chatSocket.close();
                    }
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            });
        }

        function searchContacts() {
            clearTimeout(state.searchTimeout);
            const searchTerm = DOM.searchInput.value;
            DOM.clearSearchBtn.classList.toggle('hidden', searchTerm.trim() === '');
            state.searchTimeout = setTimeout(() => {
                fetch(`/api/search_chats/?q=${encodeURIComponent(searchTerm)}`)
                    .then(r => r.json())
                    .then(data => updateContactList(data.contacts));
            }, 300);
        }
        
        function clearSearch() {
            DOM.searchInput.value = '';
            DOM.backBtn.classList.add('hidden');
            DOM.sidebarTitle.classList.remove('hidden');
            searchContacts();
        }
        
        function backToAllChats() {
            clearSearch();
        }

        function addContactToList(contact, prepend = false) {
            const contactEl = document.createElement('div');
            contactEl.className = 'contact-item';
            contactEl.dataset.phone = contact;
            contactEl.innerHTML = `
                <span class="contact-name">${contact}</span>
                <button class="delete-chat-btn">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                </button>`;
            contactEl.addEventListener('click', () => loadChat(contact));
            contactEl.querySelector('.delete-chat-btn').addEventListener('click', (e) => deleteChat(e, contact));
            if (prepend) DOM.contactList.prepend(contactEl);
            else DOM.contactList.appendChild(contactEl);
        }

        function updateContactList(contacts) {
            DOM.contactList.innerHTML = '';
            if (contacts.length === 0) {
                DOM.contactList.innerHTML = '<div class="no-results">No chats found.</div>';
            } else {
                contacts.forEach(contact => addContactToList(contact));
                if (state.activePhoneNumber && document.querySelector(`.contact-item[data-phone="${state.activePhoneNumber}"]`)) {
                    document.querySelector(`.contact-item[data-phone="${state.activePhoneNumber}"]`).classList.add('active');
                }
            }
        }

        // --- INITIAL EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            DOM.messageSubmit.addEventListener('click', sendMessage);
            DOM.messageInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') sendMessage(); });
            DOM.searchInput.addEventListener('keyup', searchContacts);
            DOM.clearSearchBtn.addEventListener('click', clearSearch);
            DOM.addChatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                fetch("{% url 'start_new_chat' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ phone_number: document.getElementById('new-chat-number').value, template_name: document.getElementById('new-chat-template').value })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        closeModal();
                        if (!document.querySelector(`.contact-item[data-phone="${data.phone_number}"]`)) {
                            addContactToList(data.phone_number, true);
                        }
                        loadChat(data.phone_number);
                    } else {
                        DOM.modalError.textContent = data.error || 'An error occurred.';
                        DOM.modalError.classList.remove('hidden');
                    }
                });
            });
            
            document.querySelectorAll('.contact-item').forEach(item => {
                item.addEventListener('click', () => loadChat(item.dataset.phone));
                item.querySelector('.delete-chat-btn').addEventListener('click', (e) => deleteChat(e, item.dataset.phone));
            });
        });
    </script>
</body>
</html>