{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat</title>
    <link rel="stylesheet" href="{% static 'sender_app/css/styles.css' %}">
</head>
<body>
    <!-- "Add New Chat" Modal -->
    <div id="add-chat-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Start a New Chat</h3>
            <form id="add-chat-form" class="modal-form">
                <input type="text" id="new-chat-number" name="phone_number" placeholder="Enter phone number (e.g., 15551234567)" required>
                <input type="text" id="new-chat-template" name="template_name" placeholder="Enter template name (e.g., hello_world)" required>
                <button type="submit">Send Template & Start Chat</button>
                <div id="modal-error" class="hidden"></div>
            </form>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar with Contact List -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="header-top-row">
                    <h2>Chats</h2>
                    <div class="header-actions">
                        <button class="action-btn" title="New Chat" onclick="openModal()">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M19.005 3.175H4.674C3.642 3.175 3 3.784 3 4.792v10.327c0 .525.22 1.023.6 1.394l2.85 2.851c.371.371.87.592 1.394.592h11.161c1.032 0 1.64-1.284 1.64-2.292V4.792c0-1.008-.608-1.617-1.64-1.617zM4.674 4.425h14.331c.448 0 .448.425.448.867v10.327c0 .442 0 .867-.448.867H8.918a.563.563 0 0 1-.398-.166L5.67 13.52a.563.563 0 0 1-.166-.398V4.792c0-.442.02-.367.448-.367zM11 11.25H8v1.5h3v3h1.5v-3h3v-1.5h-3v-3H11v3z"></path></svg>
                        </button>
                        <form action="{% url 'logout_view' %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="action-btn" title="Logout">
                                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 4l1.4 1.4L7.8 11H20v2H7.8l5.6 5.6L12 20l-8-8 8-8z"></path></svg>
                            </button>
                        </form>
                    </div>
                </div>
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="search-contacts" placeholder="Search chats..." onkeyup="searchContacts()">
                    </div>
                    <button id="clear-search-btn" class="clear-search-btn hidden" onclick="clearSearch()">&times;</button>
                </div>
            </header>
            <div class="contact-list" id="contact-list-panel">
                {% for contact in contacts %}
                    <div class="contact-item" data-phone="{{ contact }}" onclick="loadChat('{{ contact }}')">
                        <span class="contact-name">{{ contact }}</span>
                        <button class="delete-chat-btn" onclick="deleteChat(event, '{{ contact }}')">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                        </button>
                    </div>
                {% endfor %}
            </div>
        </aside>

        <!-- Main Chat Panel (No structural changes needed) -->
        <main class="chat-panel" id="chat-panel">
            <div id="chat-placeholder" class="">
                <h2>Select a chat to start messaging</h2>
            </div>
            <div id="active-chat-area" class="hidden">
                <header class="chat-header" id="chat-header"></header>
                <div class="chat-log" id="chat-log">
                    <div class="chat-log-container" id="chat-log-container"></div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-message-input" placeholder="Type a message...">
                    <button id="chat-message-submit">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentChatSocket = null;
        let activePhoneNumber = null;
        let searchTimeout;

        function loadChat(phoneNumber) {
            activePhoneNumber = phoneNumber;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('active-chat-area').classList.remove('hidden');

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`).classList.add('active');

            const chatLog = document.getElementById('chat-log-container');
            const chatHeader = document.getElementById('chat-header');
            chatHeader.textContent = phoneNumber;
            chatLog.innerHTML = 'Loading...';

            if (currentChatSocket) {
                currentChatSocket.close();
            }

            fetch(`/api/chat/${phoneNumber}/`)
                .then(response => response.json())
                .then(data => {
                    chatLog.innerHTML = '';
                    data.messages.forEach(msg => appendMessage(msg.message_text, msg.is_from_user));
                });

            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsPath = `${protocol}${window.location.host}/ws/chat/${phoneNumber}/`;
            currentChatSocket = new WebSocket(wsPath);

            currentChatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (activePhoneNumber === data.sender_id) {
                    appendMessage(data.message, data.is_from_user);
                }
                // DYNAMIC REORDERING
                moveContactToTop(data.sender_id);
            };

            currentChatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };
        }

        function appendMessage(message, isFromUser) {
        const chatLogContainer = document.getElementById('chat-log-container'); // where messages go
        const scrollContainer = document.getElementById('chat-log'); // the scrollable element

        const messageEl = document.createElement('div');
        messageEl.className = `message-bubble ${isFromUser ? 'message-in' : 'message-out'}`;
        messageEl.textContent = message;

        chatLogContainer.appendChild(messageEl);

        // wait one tick so the browser lays out the new element, then scroll to bottom
        setTimeout(() => {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
        }, 0);
        }

        function sendMessage() {
            const messageInput = document.getElementById('chat-message-input');
            const message = messageInput.value.trim();
            if (message === '' || !currentChatSocket || currentChatSocket.readyState !== WebSocket.OPEN) {
                return;
            }
            currentChatSocket.send(JSON.stringify({
                'message': message,
                'type': 'text'
            }));
            messageInput.value = '';
            // DYNAMIC REORDERING
            if (activePhoneNumber) {
                moveContactToTop(activePhoneNumber);
            }
        }

        document.getElementById('chat-message-submit').onclick = sendMessage;
        document.getElementById('chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        };

        // --- MODAL LOGIC (Unchanged) ---
        const modal = document.getElementById('add-chat-modal');
        const modalError = document.getElementById('modal-error');

        function openModal() { modal.classList.remove('hidden'); }
        function closeModal() {
            modal.classList.add('hidden');
            modalError.classList.add('hidden');
            document.getElementById('add-chat-form').reset();
        }

        document.getElementById('add-chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const phoneNumber = document.getElementById('new-chat-number').value;
            const templateName = document.getElementById('new-chat-template').value;
            const submitButton = this.querySelector('button');
            submitButton.disabled = true;
            modalError.classList.add('hidden');

            fetch("{% url 'start_new_chat' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ phone_number: phoneNumber, template_name: templateName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    if (!document.querySelector(`.contact-item[data-phone="${data.phone_number}"]`)) {
                        const contactList = document.getElementById('contact-list-panel');
                        const newContactEl = document.createElement('div');
                        newContactEl.className = 'contact-item';
                        newContactEl.dataset.phone = data.phone_number;
                        newContactEl.innerHTML = `
                            <span class="contact-name">${data.phone_number}</span>
                            <button class="delete-chat-btn" onclick="deleteChat(event, '${data.phone_number}')">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                            </button>`;
                        newContactEl.onclick = () => loadChat(data.phone_number);
                        contactList.prepend(newContactEl);
                    }
                    loadChat(data.phone_number);
                } else {
                    modalError.textContent = data.error || 'An unknown error occurred.';
                    modalError.classList.remove('hidden');
                }
            })
            .finally(() => { submitButton.disabled = false; });
        });
        
        // --- NEW & UPDATED JAVASCRIPT ---
        function moveContactToTop(phoneNumber) {
            const contactList = document.getElementById('contact-list-panel');
            const contactToMove = document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`);
            if (contactToMove) {
                contactList.prepend(contactToMove);
            }
        }
        
        function deleteChat(event, phoneNumber) {
            event.stopPropagation();
            if (confirm(`Are you sure you want to delete the entire chat history with ${phoneNumber}? This cannot be undone.`)) {
                fetch(`/api/delete_chat/${phoneNumber}/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const contactEl = document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`);
                        contactEl.remove();
                        if (activePhoneNumber === phoneNumber) {
                            document.getElementById('active-chat-area').classList.add('hidden');
                            document.getElementById('chat-placeholder').classList.remove('hidden');
                            activePhoneNumber = null;
                            if(currentChatSocket) currentChatSocket.close();
                        }
                    } else {
                        alert('Error deleting chat: ' + data.error);
                    }
                });
            }
        }

        const searchInput = document.getElementById('search-contacts');
        const clearSearchBtn = document.getElementById('clear-search-btn');

        function searchContacts() {
            clearTimeout(searchTimeout);
            const searchTerm = searchInput.value;
            clearSearchBtn.classList.toggle('hidden', searchTerm === '');

            searchTimeout = setTimeout(() => {
                fetch(`/api/search_chats/?q=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => updateContactList(data.contacts));
            }, 300);
        }
        
        function clearSearch() {
            searchInput.value = '';
            searchContacts();
        }

        function updateContactList(contacts) {
            const contactListPanel = document.getElementById('contact-list-panel');
            contactListPanel.innerHTML = '';
            if (contacts.length === 0) {
                contactListPanel.innerHTML = '<div class="no-results" style="padding: 15px; text-align: center; color: var(--text-secondary);">No chats found.</div>';
            } else {
                contacts.forEach(contact => {
                    const newContactEl = document.createElement('div');
                    newContactEl.className = 'contact-item';
                    newContactEl.dataset.phone = contact;
                    newContactEl.innerHTML = `
                        <span class="contact-name">${contact}</span>
                        <button class="delete-chat-btn" onclick="deleteChat(event, '${contact}')">
                            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                        </button>`;
                    newContactEl.onclick = () => loadChat(contact);
                    if (contact === activePhoneNumber) {
                        newContactEl.classList.add('active');
                    }
                    contactListPanel.appendChild(newContactEl);
                });
            }
        }
    </script>
</body>
</html>

