<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat</title>
    <style>
        :root {
            --background-color: #0e1621;
            --sidebar-bg: #111b21;
            --chat-panel-bg: #0b141a;
            --header-bg: #202c33;
            --search-bg: #202c33;
            --contact-hover-bg: #2a3942;
            --message-out-bg: #005c4b;
            --message-in-bg: #202c33;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --border-color: #222e35;
        }
        body, html { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar (Contact List) */
        .sidebar { width: 350px; min-width: 300px; display: flex; flex-direction: column; background-color: var(--sidebar-bg); border-right: 1px solid var(--border-color); }
        .sidebar-header { padding: 10px 16px; background-color: var(--header-bg); display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; color: var(--text-primary); font-size: 1.1rem; font-weight: 500;}
        .logout-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; padding: 5px; }
        .logout-btn:hover { color: var(--text-primary); }
        .contact-list { overflow-y: auto; flex-grow: 1; }
        .contact-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        .contact-item:hover { background-color: var(--contact-hover-bg); }
        .contact-item.active { background-color: #2a3942; }

        /* Chat Panel */
        .chat-panel { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--chat-panel-bg); }
        .chat-header { padding: 10px 16px; background-color: var(--header-bg); color: var(--text-primary); font-weight: 500; }
        .chat-log { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .chat-log-container { max-width: 800px; width: 100%; margin: 0 auto; display: flex; flex-direction: column; }
        .message-bubble { max-width: 70%; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; color: var(--text-primary); line-height: 1.4; word-wrap: break-word; }
        .message-in { background-color: var(--message-in-bg); align-self: flex-start; }
        .message-out { background-color: var(--message-out-bg); align-self: flex-end; }
        .chat-input-area { display: flex; padding: 10px 16px; background-color: var(--header-bg); }
        #chat-message-input { flex-grow: 1; border: none; padding: 12px; border-radius: 20px; background-color: var(--search-bg); color: var(--text-primary); font-size: 1rem; }
        #chat-message-input:focus { outline: none; }
        #chat-message-submit { background-color: transparent; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0 15px; }
        #chat-message-submit:hover { color: var(--text-primary); }
        .chat-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 100%; color: var(--text-secondary); }
        .chat-placeholder h2 { font-weight: 300; }
        .hidden { display: none; }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar with Contact List -->
        <aside class="sidebar">
            <header class="sidebar-header">
                <h2>Chats</h2>
                <form action="{% url 'logout_view' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn" title="Logout">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M12 4l1.4 1.4L7.8 11H20v2H7.8l5.6 5.6L12 20l-8-8 8-8z"></path></svg>
                    </button>
                </form>
            </header>
            <div class="contact-list" id="contact-list-panel">
                {% for contact in contacts %}
                    <div class="contact-item" data-phone="{{ contact }}" onclick="loadChat('{{ contact }}')">
                        {{ contact }}
                    </div>
                {% endfor %}
            </div>
        </aside>

        <!-- Main Chat Panel -->
        <main class="chat-panel" id="chat-panel">
            <div class="chat-placeholder" id="chat-placeholder">
                <div>
                    <svg viewBox="0 0 90 90" width="250" height="250" fill="#2a3942"><path d="M45 90C20.1 90 0 69.9 0 45S20.1 0 45 0s45 20.1 45 45-20.1 45-45 45zM45 4C22.4 4 4 22.4 4 45s18.4 41 41 41 41-18.4 41-41S67.6 4 45 4z"></path><path d="M22.5 45c0-12.4 10.1-22.5 22.5-22.5s22.5 10.1 22.5 22.5-10.1 22.5-22.5 22.5-22.5-10.1-22.5-22.5zm4 0c0 10.2 8.3 18.5 18.5 18.5s18.5-8.3 18.5-18.5-8.3-18.5-18.5-18.5-18.5 8.3-18.5 18.5z"></path></svg>
                    <h2>WhatsApp Web</h2>
                    <p>Select a chat to start messaging.</p>
                </div>
            </div>

            <div id="active-chat-area" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
                <header class="chat-header" id="chat-header-number"></header>
                <div class="chat-log" id="chat-log">
                    <div class="chat-log-container" id="chat-log-container">
                        <!-- Messages will be injected here by JavaScript -->
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-message-input" placeholder="Type a message..." autocomplete="off">
                    <button id="chat-message-submit">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let chatSocket = null;
        let currentPhoneNumber = null;

        function loadChat(phoneNumber) {
            currentPhoneNumber = phoneNumber;

            // Highlight the active contact
            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`).classList.add('active');

            // Show chat area and hide placeholder
            document.getElementById('chat-placeholder').classList.add('hidden');
            const activeChatArea = document.getElementById('active-chat-area');
            activeChatArea.classList.remove('hidden');

            // Set chat header
            document.getElementById('chat-header-number').textContent = phoneNumber;
            const chatLogContainer = document.getElementById('chat-log-container');
            const chatLog = document.getElementById('chat-log');
            chatLogContainer.innerHTML = 'Loading...'; // Clear previous chat

            // Fetch chat history
            fetch(`/api/chat/${phoneNumber}/`)
                .then(response => response.json())
                .then(data => {
                    chatLogContainer.innerHTML = ''; // Clear "Loading..."
                    data.messages.forEach(msg => {
                        appendMessage(msg.message_text, msg.is_from_user);
                    });
                    chatLog.scrollTop = chatLog.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching chat history:', error);
                    chatLogContainer.innerHTML = 'Failed to load chat history.';
                });

            // Close existing WebSocket connection if any
            if (chatSocket) {
                chatSocket.close();
            }

            // Establish new WebSocket connection
            const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
            chatSocket = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${phoneNumber}/`);

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                appendMessage(data.message, data.is_from_user);
                chatLog.scrollTop = chatLog.scrollHeight;
            };

            chatSocket.onclose = function(e) {
                console.error('Chat socket closed unexpectedly');
            };
        }

        function appendMessage(message, isFromUser) {
            const chatLogContainer = document.getElementById('chat-log-container');
            const messageEl = document.createElement('div');
            messageEl.classList.add('message-bubble');
            messageEl.classList.add(isFromUser ? 'message-in' : 'message-out');
            messageEl.textContent = message;
            chatLogContainer.appendChild(messageEl);
        }

        function sendMessage() {
            const messageInput = document.getElementById('chat-message-input');
            const message = messageInput.value.trim();

            if (message === '' || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                return;
            }

            // Send message through WebSocket
            chatSocket.send(JSON.stringify({
                'message': message,
                'message_type': 'text' // For now, we only send text.
            }));
            
            // Optimistically add the message to the UI
            appendMessage(message, false);
            const chatLog = document.getElementById('chat-log');
            chatLog.scrollTop = chatLog.scrollHeight;
            
            messageInput.value = ''; // Clear input field
            messageInput.focus();
        }

        document.getElementById('chat-message-submit').onclick = sendMessage;
        document.getElementById('chat-message-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>
</body>
</html>

