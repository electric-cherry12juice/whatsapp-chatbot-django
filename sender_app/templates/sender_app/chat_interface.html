{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Chat</title>
    <link rel="stylesheet" href="{% static 'sender_app/css/styles.css' %}">
</head>
<body>
    <!-- "Add New Chat" Modal (hidden by default) -->
    <div id="add-chat-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3>Start a New Chat</h3>
            <form id="add-chat-form" class="modal-form">
                <input type="text" id="new-chat-number" name="phone_number" placeholder="Enter phone number (e.g., 15551234567)" required>
                <input type="text" id="new-chat-template" name="template_name" placeholder="Enter template name (e.g., hello_world)" required>
                <button type="submit">Send Template & Start Chat</button>
                <div id="modal-error" class="hidden"></div>
            </form>
        </div>
    </div>

    <div class="app-container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <!-- ... -->
                <div class="search-container">
                    <div class="search-bar">
                        <input type="text" id="search-contacts" placeholder="Search chats..." onkeyup="searchContacts()">
                    </div>
                    <button id="clear-search-btn" class="clear-search-btn hidden" onclick="clearSearch()">&times;</button>
                </div>
            </header>
            <div class="contact-list" id="contact-list-panel">
                {% for contact in contacts %}
                    <div class="contact-item" data-phone="{{ contact }}" onclick="loadChat('{{ contact }}')">
                        <span class="contact-name">{{ contact }}</span>
                        <button class="delete-chat-btn" onclick="deleteChat(event, '{{ contact }}')">
                            <!-- SVG icon -->
                        </button>
                    </div>
                {% endfor %}
            </div>
        </aside>
        <!-- ... (Main chat panel is unchanged) ... -->
    </div>

        <!-- Main Chat Panel -->
        <main class="chat-panel" id="chat-panel">
            <div id="chat-placeholder" class="">
                <h2>Select a chat to start messaging</h2>
            </div>
            <div id="active-chat-area" class="hidden">
                <header class="chat-header" id="chat-header"></header>
                <div class="chat-log" id="chat-log">
                    <div class="chat-log-container" id="chat-log-container"></div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-message-input" placeholder="Type a message...">
                    <button id="chat-message-submit">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentChatSocket = null;
        let activePhoneNumber = null;
        let searchTimeout;

        function loadChat(phoneNumber) {
            activePhoneNumber = phoneNumber;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('active-chat-area').classList.remove('hidden');

            document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.contact-item[data-phone="${phoneNumber}"]`).classList.add('active');

            const chatLog = document.getElementById('chat-log-container');
            const chatHeader = document.getElementById('chat-header');
            chatHeader.textContent = phoneNumber;
            chatLog.innerHTML = 'Loading history...';

            if (currentChatSocket) {
                currentChatSocket.close();
            }

            fetch(`/api/chat/${phoneNumber}/`)
                .then(response => response.json())
                .then(data => {
                    chatLog.innerHTML = '';
                    data.messages.forEach(msg => appendMessage(msg.message_text, msg.is_from_user));
                });

            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsPath = `${protocol}${window.location.host}/ws/chat/${phoneNumber}/`;
            currentChatSocket = new WebSocket(wsPath);

            currentChatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                // Only append if the message is for the currently active chat
                if (activePhoneNumber === data.sender_id) {
                    appendMessage(data.message, data.is_from_user);
                }
            };

            currentChatSocket.onerror = function(e) {
                console.error('WebSocket error:', e);
            };
        }

        function appendMessage(message, isFromUser) {
            const chatLog = document.getElementById('chat-log-container');
            const messageEl = document.createElement('div');
            messageEl.className = `message-bubble ${isFromUser ? 'message-in' : 'message-out'}`;
            messageEl.textContent = message;
            chatLog.appendChild(messageEl);
            chatLog.parentElement.scrollTop = chatLog.parentElement.scrollHeight;
        }

        function sendMessage() {
            const messageInput = document.getElementById('chat-message-input');
            const message = messageInput.value.trim();
            if (message === '' || !currentChatSocket || currentChatSocket.readyState !== WebSocket.OPEN) {
                return;
            }
            currentChatSocket.send(JSON.stringify({
                'message': message,
                'type': 'text'
            }));
            messageInput.value = '';
        }

        document.getElementById('chat-message-submit').onclick = sendMessage;
        document.getElementById('chat-message-input').onkeyup = function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        };

        // --- MODAL JAVASCRIPT ---
        const modal = document.getElementById('add-chat-modal');
        const modalError = document.getElementById('modal-error');

        function openModal() {
            modal.classList.remove('hidden');
        }

        function closeModal() {
            modal.classList.add('hidden');
            modalError.classList.add('hidden');
            document.getElementById('add-chat-form').reset();
        }

        document.getElementById('add-chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const phoneNumber = document.getElementById('new-chat-number').value;
            const templateName = document.getElementById('new-chat-template').value;
            const submitButton = this.querySelector('button');
            submitButton.textContent = 'Sending...';
            submitButton.disabled = true;
            modalError.classList.add('hidden');

            fetch("{% url 'start_new_chat' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ phone_number: phoneNumber, template_name: templateName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    if (!document.querySelector(`.contact-item[data-phone="${data.phone_number}"]`)) {
                        const contactList = document.getElementById('contact-list-panel');
                        const newContactEl = document.createElement('div');
                        newContactEl.className = 'contact-item';
                        newContactEl.dataset.phone = data.phone_number;
                        newContactEl.textContent = data.phone_number;
                        newContactEl.onclick = () => loadChat(data.phone_number);
                        contactList.prepend(newContactEl);
                    }
                    loadChat(data.phone_number);
                } else {
                    modalError.textContent = data.error || 'An unknown error occurred.';
                    modalError.classList.remove('hidden');
                }
            })
            .catch(err => {
                modalError.textContent = 'A network error occurred. Please try again.';
                modalError.classList.remove('hidden');
            })
            .finally(() => {
                submitButton.textContent = 'Send Template & Start Chat';
                submitButton.disabled = false;
            });
        });
        
        // --- NEW SEARCH JAVASCRIPT ---
        function searchContacts() {
            // Debounce the search to avoid spamming the server
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('search-contacts').value;
                fetch(`/api/search_chats/?q=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(data => {
                        updateContactList(data.contacts);
                    });
            }, 300); // Wait 300ms after user stops typing
        }

        function updateContactList(contacts) {
            const contactListPanel = document.getElementById('contact-list-panel');
            contactListPanel.innerHTML = ''; // Clear the list
            if (contacts.length === 0) {
                contactListPanel.innerHTML = '<div class="no-results">No chats found.</div>';
            } else {
                contacts.forEach(contact => {
                    const newContactEl = document.createElement('div');
                    newContactEl.className = 'contact-item';
                    newContactEl.dataset.phone = contact;
                    newContactEl.textContent = contact;
                    newContactEl.onclick = () => loadChat(contact);
                    // Re-apply active class if the searched contact is the active one
                    if (contact === activePhoneNumber) {
                        newContactEl.classList.add('active');
                    }
                    contactListPanel.appendChild(newContactEl);
                });
            }
        }
    </script>
</body>
</html>


