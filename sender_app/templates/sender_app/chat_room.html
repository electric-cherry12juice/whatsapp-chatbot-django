<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ phone_number }}</title>
    <style>
        :root {
            --bg-color: #0e1621;
            --sidebar-bg: #17212b;
            --header-bg: #242f3d;
            --text-color: #fff;
            --text-secondary: #a3b0c1;
            --bubble-out: #2b5278;
            --bubble-in: #262d31;
            --input-bg: #242f3d;
            --send-btn-color: #3e95e1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; overflow: hidden;}
        .chat-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        .chat-header { background-color: var(--header-bg); padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid var(--bg-color); }
        .back-link { color: var(--text-color); text-decoration: none; font-size: 24px; margin-right: 20px; }
        .chat-header h2 { margin: 0; font-size: 18px; font-weight: 600; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .message-bubble { max-width: 65%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; line-height: 1.4; word-wrap: break-word; }
        .message-bubble.sent { background-color: var(--bubble-out); align-self: flex-end; border-bottom-right-radius: 5px; }
        .message-bubble.received { background-color: var(--bubble-in); align-self: flex-start; border-bottom-left-radius: 5px; }
        .chat-input-area { background-color: var(--header-bg); padding: 15px; display: flex; align-items: center; border-top: 1px solid var(--bg-color); }
        .chat-input-area input { flex-grow: 1; border: none; background-color: var(--input-bg); color: var(--text-color); padding: 12px 15px; border-radius: 20px; font-size: 16px; outline: none; }
        .chat-input-area input::placeholder { color: var(--text-secondary); }
        .chat-input-area button { background: none; border: none; color: var(--send-btn-color); font-size: 24px; margin-left: 15px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <a href="{% url 'contact_list' %}" class="back-link">&larr;</a>
            <h2>{{ phone_number }}</h2>
        </div>
        <div class="chat-messages" id="chat-log">
            {% for message in messages %}
                <div class="message-bubble {% if message.is_from_user %}received{% else %}sent{% endif %}">
                    {{ message.message_text }}
                </div>
            {% endfor %}
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-message-input" placeholder="Message..." autocomplete="off">
            <button id="chat-message-submit">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M1.101 21.757L23.8 12.028 1.101 2.3l.011 7.912 13.623 1.816-13.623 1.817-.011 7.912z"></path></svg>
            </button>
        </div>
    </div>

    <script>
        const phoneNumber = {{ phone_number|json_script:"phone-number" }};
        const chatLog = document.getElementById('chat-log');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');

        function scrollToBottom() {
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        scrollToBottom();

        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const chatSocket = new WebSocket(
            protocol + '://' + window.location.host + '/ws/chat/' + phoneNumber + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            bubble.classList.add(data.is_from_user ? 'received' : 'sent');
            bubble.textContent = data.message;
            chatLog.appendChild(bubble);
            scrollToBottom();
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() !== '') {
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'type': 'text' // For now, we only send text. We could add a toggle for 'template'.
                }));
                messageInput.value = '';
            }
        }

        messageSubmit.onclick = sendMessage;
        messageInput.addEventListener('keyup', function(e) {
            if (e.keyCode === 13) { // Enter key
                sendMessage();
            }
        });
    </script>
</body>
</html>

